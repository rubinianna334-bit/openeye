<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anna Rubini - OpenEye</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: black;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Animazione per la scritta centrale */
        .fade-out-custom {
            animation: fadeOut 2s ease-in-out forwards;
            animation-delay: 8s;
            /* Inizia a sfumare dopo 8 secondi per sparire a 10 */
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
                visibility: hidden;
            }
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">

    <div id="intro-overlay" class="fixed inset-0 z-[60] bg-black flex items-center justify-center fade-out-custom">
        <h1 class="text-white text-5xl font-black tracking-[0.2em] uppercase animate-pulse">
            OPENEYE
        </h1>
    </div>


    </div>

    <div class="z-10 text-center">
        <audio id="alert-sound" src="assets/alert.mp3" preload="auto"></audio>
        <div id="status-badge"
            class="glass px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest text-white mb-4 inline-block opacity-0 transition-opacity duration-500">
            Notification Received
        </div>
    </div>

    <div class="fixed inset-0 z-0 overflow-hidden bg-black">
        <video id="video-loop" autoplay playsinline loop
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full object-cover brightness-[0.5] transition-opacity duration-500 opacity-100">
            <source src="assets/loop_occhi_chiusi.mp4" type="video/mp4">
        </video>

        <video id="video-action" muted playsinline
            class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full object-cover brightness-[0.5] transition-opacity duration-500 opacity-0">
            <source src="assets/apertura_occhi.mp4" type="video/mp4">
        </video>
    </div>

    <script>
        const videoLoop = document.getElementById('video-loop');
        const videoAction = document.getElementById('video-action');
        const statusBadge = document.getElementById('status-badge');
        const alertSound = document.getElementById('alert-sound');
        const splash = document.getElementById('splash');
        const startBtn = document.getElementById('start-btn');
        const introOverlay = document.getElementById('intro-overlay');

        let experienceStarted = false;

        // Gestione automatica rimozione intro dopo 10 secondi
        setTimeout(() => {
            introOverlay.style.display = 'none';
        }, 10500);

        // Funzione per avviare l'esperienza
        startBtn.onclick = () => {
            experienceStarted = true;
            splash.classList.add('opacity-0', 'pointer-events-none', 'scale-110');

            // Avvia il loop
            videoLoop.play();

            // "Prime" media per evitare ritardi sui browser mobile
            videoAction.play().then(() => { videoAction.pause(); videoAction.currentTime = 0; });
            alertSound.play().then(() => { alertSound.pause(); alertSound.currentTime = 0; });

            connectSSE();
        };

        // Logica per l'apertura occhi (Triggerata da SSE o test)
        function triggerEyeOpening() {
            if (!experienceStarted) return;

            console.log('Switching to Eye Opening Video...');

            // 1. Mostra video azione, nascondi loop
            videoAction.classList.replace('opacity-0', 'opacity-100');
            videoLoop.classList.replace('opacity-100', 'opacity-0');

            // 2. Play video e audio
            videoAction.currentTime = 0;
            videoAction.play();
            alertSound.play().catch(e => console.log('Audio error:', e));
            statusBadge.classList.replace('opacity-0', 'opacity-100');

            // 3. Quando finisce l'apertura, torna al loop
            videoAction.onended = () => {
                videoLoop.classList.replace('opacity-0', 'opacity-100');
                videoAction.classList.replace('opacity-100', 'opacity-0');
                videoLoop.play();
                statusBadge.classList.replace('opacity-100', 'opacity-0');
            };
        }

        // Connessione SSE al tuo server porta 3100
        function connectSSE() {
            const eventSource = new EventSource('http://localhost:3100/events');

            eventSource.onmessage = (event) => {
                triggerEyeOpening();
            };

            eventSource.onerror = (err) => {
                console.error('SSE connection lost. Retrying...');
                eventSource.close();
                setTimeout(connectSSE, 3000);
            };
        }

        // TEST RAPIDO: Premi "Barra Spaziatrice" per testare l'apertura senza aspettare SSE
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') triggerEyeOpening();
        });
        // Aggiungi questo in fondo al tuo <script>
        const startExperience = () => {
            if (!experienceStarted) {
                experienceStarted = true;

                // Nascondi l'intro se è ancora visibile
                introOverlay.style.display = 'none';

                // Avvia il loop
                videoLoop.play().catch(error => {
                    console.error("Errore nell'avvio del video:", error);
                });

                // Pre-carica il video dell'apertura
                videoAction.play().then(() => {
                    videoAction.pause();
                    videoAction.currentTime = 0;
                });

                connectSSE();
            }
        };

        // Avvia al primo clic o tocco ovunque sulla pagina
        window.addEventListener('click', startExperience);
        window.addEventListener('touchstart', startExperience);

        // Prova anche l'avvio automatico (funziona solo se il video è MUTED)
        window.onload = () => {
            videoLoop.play().then(() => {
                experienceStarted = true;
                connectSSE();
            }).catch(e => {
                console.log("Autoplay bloccato, attesa clic dell'utente.");
            });
        };
    </script>
</body>

</html>