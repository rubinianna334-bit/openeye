<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Bridge - Cinema Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen flex flex-col items-center justify-center p-4 relative overflow-hidden">
    <!-- Splash Overlay -->
    <div id="splash"
        class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-950 transition-all duration-700">
        <div class="text-center animate-in fade-in zoom-in duration-1000">
            <h2
                class="text-4xl font-black mb-8 bg-clip-text text-transparent bg-gradient-to-r from-cyan-400 to-blue-500">
                SYSTEM READY
            </h2>
            <button id="start-btn"
                class="glass px-12 py-5 rounded-full font-black text-xl hover:bg-cyan-500 hover:text-black transition-all hover:scale-110 shadow-[0_0_30px_rgba(34,211,238,0.2)]">
                START EXPERIENCE
            </button>
            <p class="mt-6 text-slate-500 text-xs tracking-widest">
                INTERACTION REQUIRED FOR AUDIO/VIDEO
            </p>
        </div>
    </div>

    <!-- UI Overlay -->
    <div class="z-10 text-center animate-in fade-in duration-1000">
        <audio id="alert-sound" src="assets/alert.mp3" preload="auto"></audio>
        <div id="status-badge"
            class="glass px-4 py-1 rounded-full text-xs font-bold uppercase tracking-widest text-white mb-4 inline-block opacity-0 transition-opacity">
            Notification
        </div>
        <Z </div>
            <!-- Video Background Container -->
            <div class="fixed inset-0 z-0 overflow-hidden">
                <video id="main-video" muted playsinline
                    class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 min-w-full min-h-full object-cover brightness-[0.5]">
                    <source src="assets/video.mp4" type="video/mp4">
                </video>
            </div>


            <script>
                const video = document.getElementById('main-video');
                const sseDot = document.getElementById('sse-dot');
                const statusBadge = document.getElementById('status-badge');
                const alertSound = document.getElementById('alert-sound');
                const splash = document.getElementById('splash');
                const startBtn = document.getElementById('start-btn');

                let config = null;
                let currentState = 'idle';
                let experienceStarted = false;

                // Load configuration
                fetch('assets/video-config.json')
                    .then(res => res.json())
                    .then(data => {
                        config = data;
                        console.log('Video config loaded:', config);
                    })
                    .catch(err => console.error('Failed to load video config:', err));

                // Start Experience on Click
                startBtn.onclick = () => {
                    if (!config) return;

                    experienceStarted = true;
                    splash.classList.add('opacity-0', 'pointer-events-none', 'scale-110');

                    // Initialize media
                    video.currentTime = config.idle.start;
                    video.play();

                    // "Prime" the audio for later play (some browsers need this)
                    alertSound.play().then(() => {
                        alertSound.pause();
                        alertSound.currentTime = 0;
                    }).catch(e => console.log('Audio priming skipped:', e));

                    startPlaybackEngine();
                    connectSSE();
                };

                function startPlaybackEngine() {
                    // Using requestAnimationFrame for precise timecode tracking
                    function checkTime() {
                        if (!config || !experienceStarted) return requestAnimationFrame(checkTime);

                        const currentTime = video.currentTime;

                        if (currentState === 'idle') {
                            if (currentTime >= config.idle.end) {
                                video.currentTime = config.idle.start;
                                video.play();
                            }
                        } else if (currentState === 'event') {
                            if (currentTime >= config.event.end) {
                                console.log('Event finished, returning to idle');
                                currentState = 'idle';
                                video.currentTime = config.idle.start;
                                video.play();
                                statusBadge.classList.add('opacity-0');
                            }
                        }

                        requestAnimationFrame(checkTime);
                    }
                    requestAnimationFrame(checkTime);
                }

                // SSE Connection to trigger "event" state
                function connectSSE() {
                    const eventSource = new EventSource('/events');

                    eventSource.onopen = () => {
                        sseDot.classList.replace('bg-red-500', 'bg-emerald-500');
                        console.log('SSE connected for video trigger');
                    };

                    eventSource.onmessage = (event) => {
                        console.log('Event received! Switching video state...');
                        if (config && experienceStarted) {
                            currentState = 'event';
                            video.currentTime = config.event.start;
                            video.play();

                            // Play audio alert
                            alertSound.play().catch(e => console.log('Audio playback failed:', e));

                            // Show UI feedback
                            statusBadge.classList.remove('opacity-0');
                        }
                    };

                    eventSource.onerror = (err) => {
                        sseDot.classList.replace('bg-emerald-500', 'bg-red-500');
                        console.error('SSE Error:', err);
                        // Attempt to reconnect after 3 seconds
                        eventSource.close();
                        setTimeout(connectSSE, 3000);
                    };
                }
            </script>
</body>

</html>